#!/usr/bin/perl

# Author: Daniel "Trizen" È˜uteu
# Date: 28 January 2019
# https://github.com/trizen

# A new algorithm for generating Fermat overpseudoprimes to base 2.

# See also:
#   https://oeis.org/A141232 -- Overpseudoprimes to base 2: composite k such that k = A137576((k-1)/2).

# See also:
#   https://en.wikipedia.org/wiki/Fermat_pseudoprime
#   https://trizenx.blogspot.com/2018/08/investigating-fibonacci-numbers-modulo-m.html

use 5.020;
use warnings;
use experimental qw(signatures);

use Math::AnyNum qw(prod);
use ntheory qw(forcomb forprimes kronecker divisors lucas_sequence powmod znorder);

sub fermat_overpseudoprimes ($limit, $callback) {

    my %common_divisors;

    forprimes {
        my $p = $_;
        my $z = znorder(2, $p);
        push @{$common_divisors{$z}}, $p;
    } 3, $limit;

    my %seen;

    foreach my $arr (values %common_divisors) {

        my $l = $#{$arr} + 1;

        foreach my $k (2 .. $l) {
            forcomb {
                my $n = prod(@{$arr}[@_]);
                $callback->($n, @{$arr}[@_]) if !$seen{$n}++;
            } $l, $k;
        }
    }
}

sub is_fermat_pseudoprime ($n, $base) {
    powmod($base, $n - 1, $n) == 1;
}

sub is_fibonacci_pseudoprime($n) {
    (lucas_sequence($n, 1, -1, $n - kronecker($n, 5)))[0] == 0;
}

my @pseudoprimes;

fermat_overpseudoprimes(
    20_000,
    sub ($n, @f) {

        is_fermat_pseudoprime($n, 2) || die "error for n=$n";

        if (kronecker($n, 5) == -1) {
            if (is_fibonacci_pseudoprime($n)) {
                die "Found a special pseudoprime: $n = prod(@f)";
            }
        }

        push @pseudoprimes, $n;
    }
);

@pseudoprimes = sort { $a <=> $b } @pseudoprimes;

say join(', ', @pseudoprimes);

__END__
2047, 3277, 4033, 8321, 65281, 80581, 85489, 88357, 104653, 130561, 220729, 253241, 256999, 280601, 390937, 458989, 486737, 514447, 580337, 818201, 838861, 877099, 916327, 976873, 1016801, 1082401, 1145257, 1207361, 1251949, 1252697, 1325843, 1441091, 1507963, 1509709, 1530787, 1678541, 1811573, 2004403, 2181961, 2205967, 2264369, 2304167, 2387797, 2746477, 2748023, 2757241, 2811271, 2909197, 2976487, 3090091, 3116107, 3375041, 3400013, 3567481, 3898129, 4181921, 4188889, 4469471, 4513841, 5016191, 5044033, 5173169, 5173601, 5590621, 5672041, 6140161, 6226193, 6368689, 6386993, 6952037, 7306561, 7759937, 7820201, 8036033, 8534233, 9006401, 9056501, 9371251, 9564169, 9567673, 9863461, 10425511, 10610063, 10974881, 11585293, 12263131, 13338371, 13421773, 13694761, 13747361, 14179537, 14324473, 14794081, 15101893, 15139199, 15188557, 15976747, 16070429, 16324001, 16705021, 16853077, 16879501, 17116837, 17134043, 17327773, 17375249, 18073817, 18443701, 18535177, 18653353, 19404139, 20647621, 21303343, 21306157, 21400481, 22591301, 22669501, 23464033, 23577497, 23734901, 23828017, 23963869, 27108397, 27219697, 27509653, 27664033, 27798461, 27808463, 28325881, 28527049, 28572961, 29581501, 30881551, 31436123, 33627301, 33704101, 34856167, 35820937, 35851037, 36307981, 36919681, 37439201, 38010307, 38210323, 40629601, 41662297, 41840809, 42984589, 43363601, 43661257, 46325029, 46517857, 47903701, 47918581, 48191653, 48448661, 54449431, 55318957, 55729957, 56420033, 58422409, 58449847, 60352921, 60738257, 61832377, 63001801, 63167743, 63318169, 63388033, 64605041, 66096253, 68512867, 69176647, 69228967, 69485281, 72543547, 74411131, 75140137, 75565873, 80375707, 82870517, 86999837, 89308771, 91433281, 100463443, 101270251, 101276579, 110139499, 111654401, 114305441, 117987841, 119558011, 134767153, 150988753, 151533377, 158397247, 158496911, 158895281, 166082309, 168566501, 170782921, 177951973, 187667969, 196049701, 214858717, 246099317, 251663837, 262979501, 282769771, 287449091, 464955857, 536870911, 1220114377, 1541955409, 2454285751, 5256967999, 5726579371, 7030714813, 8788016089, 10545166433, 17112890881, 18723407341, 19089110641, 23652189937, 37408911097, 43215089153, 50032571509, 59850086533, 65700513721, 78889735961, 99737787437, 105207688757, 125402926477, 149583518641, 168003672409, 276676965109, 381491063773, 457804259249, 575176785409, 40925790926473, 322053315634073
